<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>Artifacts</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 2rem; }
      h2 { margin-top: 2rem; }
      button { margin-bottom: 1rem; }
      pre { padding: 1rem; background: #f5f5f5; border-radius: 4px; }
      section { margin-top: 1rem; }
      .summary-grid { display: flex; gap: 1rem; flex-wrap: wrap; }
      .summary-card { padding: 1rem; background: #eef3ff; border-radius: 6px; min-width: 180px; }
      .summary-card h3 { margin: 0 0 0.25rem; font-size: 1rem; }
      .summary-card p { margin: 0; font-size: 0.85rem; color: #333; }
      .ranking-list { padding-left: 1.5rem; }
      .ranking-list li { margin-bottom: 0.5rem; }
    </style>
  </head>
  <body>
    <h1>Hello Electron</h1>
    <h2>Stored sample data</h2>
    <button id="refresh">refresh</button>
    <pre id="out">loading...</pre>

    <h2>Project analysis</h2>
    <button id="refresh-projects">re-analyze projects</button>
    <!-- High-level project classification counts populate this summary grid -->
    <section class="summary-grid" id="project-summary"></section>
    <!-- Contribution leaderboard highlighting the dominant contributor per project -->
    <section>
      <h3>Contribution ranking</h3>
      <ol class="ranking-list" id="project-ranking"></ol>
    </section>
    <pre id="projects-out">loading...</pre>

    <script>
      const out = document.getElementById('out');
      const refreshBtn = document.getElementById('refresh');
      const projectsOut = document.getElementById('projects-out');
      const refreshProjectsBtn = document.getElementById('refresh-projects');
      const projectSummaryEl = document.getElementById('project-summary');
      const projectRankingEl = document.getElementById('project-ranking');

      function pad(num) {
        return String(num).padStart(2, '0');
      }

      function formatTimestamp(ts) {
        if (ts === null || ts === undefined) return '';
        const date = new Date(ts * 1000);
        if (Number.isNaN(date.getTime())) return String(ts);
        const y = date.getFullYear();
        const m = pad(date.getMonth() + 1);
        const d = pad(date.getDate());
        const hh = pad(date.getHours());
        const mm = pad(date.getMinutes());
        const ss = pad(date.getSeconds());
        return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
      }

      async function loadArtifacts() {
        try {
          const rows = await window.db.queryArtifacts({ limit: 100 });
          const display = rows.map((row) => ({
            ...row,
            created_at: formatTimestamp(row.created_at),
            modified_at: formatTimestamp(row.modified_at),
          }));
          out.textContent = JSON.stringify(display, null, 2);
        } catch (e) {
          console.error(e);
          out.textContent = 'data loading error, check console logs';
        }
      }

      // Convert a decimal share into human friendly percentage text.
      function formatPercent(value) {
        if (value === null || value === undefined || Number.isNaN(value)) return '—';
        return `${Math.round(value * 1000) / 10}%`;
      }

      // Render the classification summary cards shown above the ranking list.
      function renderProjectSummary(rows) {
        const counts = rows.reduce((map, row) => {
          const key = row.classification || 'unknown';
          map[key] = (map[key] ?? 0) + 1;
          return map;
        }, {});

        const cards = [
          { label: 'Individual', value: counts.individual ?? 0, description: 'Single human contributor' },
          { label: 'Collaborative', value: counts.collaborative ?? 0, description: 'Multiple human contributors' },
          { label: 'Unclassified', value: counts.unclassified ?? counts.unknown ?? 0, description: 'Pending commit data' },
        ];

        projectSummaryEl.innerHTML = cards.map((card) => `
          <div class="summary-card">
            <h3>${card.label}</h3>
            <p><strong>${card.value}</strong> projects</p>
            <p>${card.description}</p>
          </div>
        `).join('');
      }

      // Build the ordered list ranking projects by the dominant contributor's impact.
      function renderProjectRanking(rows) {
        const ranking = rows
          .map((row) => {
            const main = row.mainAuthor;
            return {
              id: row.id,
              name: row.name,
              classification: row.classification,
              totalCommits: row.totalCommits,
              humanContributors: row.humanContributorCount,
              mainAuthorName: main?.name || 'N/A',
              mainAuthorEmail: main?.email || '',
              mainAuthorCommits: main?.commits || 0,
              mainAuthorShare: main?.share ?? null,
            };
          })
          .sort((a, b) => {
            const shareA = a.mainAuthorShare ?? -1;
            const shareB = b.mainAuthorShare ?? -1;
            if (shareA !== shareB) return shareB - shareA;
            return (b.totalCommits ?? 0) - (a.totalCommits ?? 0);
          });

        if (ranking.length === 0) {
          projectRankingEl.innerHTML = '<li>No projects analyzed yet</li>';
          return;
        }

        projectRankingEl.innerHTML = ranking.map((entry) => {
          const contributorInfo = entry.mainAuthorEmail
            ? `${entry.mainAuthorName} (${entry.mainAuthorEmail})`
            : entry.mainAuthorName;
          return `
            <li>
              <strong>${entry.name}</strong> — ${entry.classification}
              <br>Lead: ${contributorInfo}
              <br>Commits: ${entry.mainAuthorCommits} (${formatPercent(entry.mainAuthorShare)} of human commits)
              <br>Total commits: ${entry.totalCommits} · Contributors: ${entry.humanContributors}
            </li>
          `;
        }).join('');
      }

      async function loadProjects({ reanalyze = false } = {}) {
        if (!window.projects) {
          projectsOut.textContent = 'project API not available';
          return;
        }
        try {
          const rows = reanalyze ? await window.projects.refresh() : await window.projects.list();
          renderProjectSummary(rows);
          renderProjectRanking(rows);
          const view = rows.map((row) => ({
            id: row.id,
            name: row.name,
            classification: row.classification,
            humanContributors: row.humanContributorCount,
            botContributors: row.botContributorCount,
            totalCommits: row.totalCommits,
            mainAuthor: row.mainAuthor ? {
              name: row.mainAuthor.name,
              email: row.mainAuthor.email,
              commits: row.mainAuthor.commits,
              contributionShare: row.mainAuthor.share,
            } : null,
            analyzedAt: formatTimestamp(row.analyzedAt),
          }));
          projectsOut.textContent = JSON.stringify(view, null, 2);
        } catch (e) {
          console.error(e);
          projectsOut.textContent = 'unable to load project analysis data';
          projectSummaryEl.innerHTML = '';
          projectRankingEl.innerHTML = '';
        }
      }

      refreshBtn.addEventListener('click', loadArtifacts);
      refreshProjectsBtn.addEventListener('click', () => loadProjects({ reanalyze: true }));
      loadArtifacts();
      loadProjects();
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          const cfg = await window.config.load();
          console.log('Loaded config:', cfg);
          await window.config.set('theme', 'dark');
        } catch (e) {
          console.error('Config error:', e);
        }
      });
    </script>
  </body>
</html>
