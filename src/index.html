<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>Artifacts</title>
   <style>
  :root{
    --bg1:#0b1220;
    --bg2:#111827;
    --card:#101826cc;   /* glass card */
    --card-border:#2a3757;
    --text:#e6eaf2;
    --muted:#9aa6bd;
    --accent:#7aa2ff;
  }

  /* full-bleed modern background */
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1100px 700px at -10% -10%, #1f2a44 0%, transparent 60%),
      radial-gradient(900px 600px at 120% 0%, #2a3a66 0%, transparent 55%),
      linear-gradient(160deg, var(--bg2) 0%, var(--bg1) 60%);
    background-attachment: fixed;
  }

  /* page container */
  body > *{
    max-width: 1100px;
    margin-inline: auto;
  }

  h1{
    margin: 28px 24px 8px;
    font-size: 28px;
    line-height: 1.2;
    letter-spacing: .3px;
    background: linear-gradient(90deg,#b3c7ff, #7aa2ff 35%, #b3e1ff 80%);
    -webkit-background-clip:text;
    background-clip:text;
    color: transparent;
  }
  h2{ margin: 18px 24px 10px; font-size: 18px; color:#d7deee }
  h3{ margin: 0 0 6px; font-size: 14px; color:#d7deee }

  /* glass panels */
  pre, section, .summary-card{
    margin: 12px 24px;
    padding: 14px 16px;
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 14px;
    box-shadow: 0 8px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02);
    backdrop-filter: blur(6px);
  }
  pre{ overflow:auto; font-size: 12px; line-height:1.45 }

  /* controls */
  button{
    margin: 0 24px 10px;
    padding: 9px 14px;
    border-radius: 12px;
    border: 1px solid #2c3b63;
    background: linear-gradient(180deg,#1d2a49,#15203b);
    color:#e6ecff;
    cursor:pointer;
    transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
  }
  button:hover{
    transform: translateY(-1px);
    border-color:#3e57a8;
    box-shadow: 0 8px 22px rgba(0,0,0,.45);
  }
  button:active{ transform: translateY(0) }

  /* summary cards grid */
  .summary-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
    margin: 12px 24px;
  }
  .summary-card{
    min-width: 0;
    background: linear-gradient(180deg, #0f172aCC, #0b1220CC);
    border-color:#2a365a;
  }
  .summary-card p{ margin: 2px 0; font-size: 12px; color: var(--muted) }
  .summary-card p strong{ color:#ffffff; font-size: 16px }

  /* ranking list */
  .ranking-list{ margin: 0; padding-left: 20px }
  .ranking-list li{
    margin: 8px 0;
    padding-left: 4px;
    color:#dbe4ff;
  }

  /* tiny responsive tweaks */
  @media (max-width:640px){
    h1{ margin:20px 16px }
    h2,pre,section,button{ margin-left:16px; margin-right:16px }
  }
</style>

  </head>
  <body>
    <h2>Stored sample data</h2>
    <button id="refresh">refresh</button>
    <pre id="out">loading...</pre>

    <h2>Project analysis</h2>
    <button id="refresh-projects">re-analyze projects</button>
    <!-- High-level project classification counts populate this summary grid -->
    <section class="summary-grid" id="project-summary"></section>
    <!-- Contribution leaderboard highlighting the dominant contributor per project -->
    <section>
      <h3>Contribution ranking</h3>
      <ol class="ranking-list" id="project-ranking"></ol>
    </section>
    <pre id="projects-out">loading...</pre>

    <script>
      const out = document.getElementById('out');
      const refreshBtn = document.getElementById('refresh');
      const projectsOut = document.getElementById('projects-out');
      const refreshProjectsBtn = document.getElementById('refresh-projects');
      const projectSummaryEl = document.getElementById('project-summary');
      const projectRankingEl = document.getElementById('project-ranking');

      function pad(num) {
        return String(num).padStart(2, '0');
      }

      function formatTimestamp(ts) {
        if (ts === null || ts === undefined) return '';
        const date = new Date(ts * 1000);
        if (Number.isNaN(date.getTime())) return String(ts);
        const y = date.getFullYear();
        const m = pad(date.getMonth() + 1);
        const d = pad(date.getDate());
        const hh = pad(date.getHours());
        const mm = pad(date.getMinutes());
        const ss = pad(date.getSeconds());
        return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
      }

      async function loadArtifacts() {
        try {
          const rows = await window.db.queryArtifacts({ limit: 100 });
          const display = rows.map((row) => ({
            ...row,
            created_at: formatTimestamp(row.created_at),
            modified_at: formatTimestamp(row.modified_at),
          }));
          out.textContent = JSON.stringify(display, null, 2);
        } catch (e) {
          console.error(e);
          out.textContent = 'data loading error, check console logs';
        }
      }

      // Convert a decimal share into human friendly percentage text.
      function formatPercent(value) {
        if (value === null || value === undefined || Number.isNaN(value)) return '—';
        return `${Math.round(value * 1000) / 10}%`;
      }

      // Render the classification summary cards shown above the ranking list.
      function renderProjectSummary(rows) {
        const counts = rows.reduce((map, row) => {
          const key = row.classification || 'unknown';
          map[key] = (map[key] ?? 0) + 1;
          return map;
        }, {});

        const cards = [
          { label: 'Individual', value: counts.individual ?? 0, description: 'Single human contributor' },
          { label: 'Collaborative', value: counts.collaborative ?? 0, description: 'Multiple human contributors' },
          { label: 'Unclassified', value: counts.unclassified ?? counts.unknown ?? 0, description: 'Pending commit data' },
        ];

        projectSummaryEl.innerHTML = cards.map((card) => `
          <div class="summary-card">
            <h3>${card.label}</h3>
            <p><strong>${card.value}</strong> projects</p>
            <p>${card.description}</p>
          </div>
        `).join('');
      }

      // Build the ordered list ranking projects by the dominant contributor's impact.
      function renderProjectRanking(rows) {
        const ranking = rows
          .map((row) => {
            const main = row.mainAuthor;
            return {
              id: row.id,
              name: row.name,
              classification: row.classification,
              totalCommits: row.totalCommits,
              humanContributors: row.humanContributorCount,
              mainAuthorName: main?.name || 'N/A',
              mainAuthorEmail: main?.email || '',
              mainAuthorCommits: main?.commits || 0,
              mainAuthorShare: main?.share ?? null,
            };
          })
          .sort((a, b) => {
            const shareA = a.mainAuthorShare ?? -1;
            const shareB = b.mainAuthorShare ?? -1;
            if (shareA !== shareB) return shareB - shareA;
            return (b.totalCommits ?? 0) - (a.totalCommits ?? 0);
          });

        if (ranking.length === 0) {
          projectRankingEl.innerHTML = '<li>No projects analyzed yet</li>';
          return;
        }

        projectRankingEl.innerHTML = ranking.map((entry) => {
          const contributorInfo = entry.mainAuthorEmail
            ? `${entry.mainAuthorName} (${entry.mainAuthorEmail})`
            : entry.mainAuthorName;
          return `
            <li>
              <strong>${entry.name}</strong> — ${entry.classification}
              <br>Lead: ${contributorInfo}
              <br>Commits: ${entry.mainAuthorCommits} (${formatPercent(entry.mainAuthorShare)} of human commits)
              <br>Total commits: ${entry.totalCommits} · Contributors: ${entry.humanContributors}
            </li>
          `;
        }).join('');
      }

      async function loadProjects({ reanalyze = false } = {}) {
        if (!window.projects) {
          projectsOut.textContent = 'project API not available';
          return;
        }
        try {
          const rows = reanalyze ? await window.projects.refresh() : await window.projects.list();
          renderProjectSummary(rows);
          renderProjectRanking(rows);
          const view = rows.map((row) => ({
            id: row.id,
            name: row.name,
            classification: row.classification,
            humanContributors: row.humanContributorCount,
            botContributors: row.botContributorCount,
            totalCommits: row.totalCommits,
            mainAuthor: row.mainAuthor ? {
              name: row.mainAuthor.name,
              email: row.mainAuthor.email,
              commits: row.mainAuthor.commits,
              contributionShare: row.mainAuthor.share,
            } : null,
            analyzedAt: formatTimestamp(row.analyzedAt),
          }));
          projectsOut.textContent = JSON.stringify(view, null, 2);
        } catch (e) {
          console.error(e);
          projectsOut.textContent = 'unable to load project analysis data';
          projectSummaryEl.innerHTML = '';
          projectRankingEl.innerHTML = '';
        }
      }

      refreshBtn.addEventListener('click', loadArtifacts);
      refreshProjectsBtn.addEventListener('click', () => loadProjects({ reanalyze: true }));
      loadArtifacts();
      loadProjects();
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          const cfg = await window.config.load();
          console.log('Loaded config:', cfg);
          await window.config.set('theme', 'dark');
        } catch (e) {
          console.error('Config error:', e);
        }
      });
    </script>
  </body>
</html>
